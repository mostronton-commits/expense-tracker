<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¥–æ—Ö–æ–¥—ñ–≤ —ñ –≤–∏—Ç—Ä–∞—Ç - Supabase</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-status {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .sync-badge.connected {
            background: #d1f4e0;
            color: #0d894f;
        }

        .sync-badge.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-badge.error {
            background: #ffe5e5;
            color: #d93025;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #6e6e73;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: #f5f5f7;
        }

        .nav-tab.active {
            background: #0071e3;
            color: white;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #6e6e73;
        }

        input, select, button {
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #0071e3;
        }

        button {
            background: #0071e3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #0077ed;
        }

        button:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .month-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .month-nav button {
            padding: 8px 16px;
            background: white;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #6e6e73;
            border-bottom: 1px solid #d2d2d7;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f5f5f7;
        }

        tr {
            position: relative;
        }

        tr::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 2px 0 0 2px;
        }

        tr.income::before {
            background: #34c759;
        }

        tr.expense::before {
            background: #ff9500;
        }

        tr.exchange::before {
            background: #8e8e93;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-delete {
            background: #ff3b30;
        }

        .btn-delete:hover {
            background: #ff453a;
        }

        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .summary-item {
            padding: 20px;
            background: #f5f5f7;
            border-radius: 8px;
        }

        .summary-label {
            font-size: 13px;
            font-weight: 500;
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 600;
        }

        .summary-value.income {
            color: #34c759;
        }

        .summary-value.expense {
            color: #ff9500;
        }

        .export-import {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .loading {
            text-align: center;
            color: #6e6e73;
            padding: 20px;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #1d1d1f;
            color: white;
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .forecast-section {
            background: #fff9e6;
            border: 2px dashed #ff9500;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .forecast-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff9500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .forecast-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-title {
            font-size: 13px;
            font-weight: 500;
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-comparison {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-comparison.positive {
            color: #34c759;
        }

        .stat-comparison.negative {
            color: #ff3b30;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            height: 300px;
            padding: 20px 0;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bars {
            display: flex;
            gap: 4px;
            width: 100%;
            align-items: flex-end;
            height: 250px;
        }

        .bar {
            flex: 1;
            border-radius: 4px 4px 0 0;
            min-height: 2px;
            position: relative;
            transition: all 0.3s;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar.income-bar {
            background: #34c759;
        }

        .bar.expense-bar {
            background: #ff9500;
        }

        .bar-label {
            font-size: 12px;
            color: #6e6e73;
            text-align: center;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .error-message {
            background: #ffe5e5;
            color: #d93025;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Supabase configuration
        const SUPABASE_URL = 'https://jukjzojpxmbjcageuucp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1a2p6b2pweG1iamNhZ2V1dWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTAxODcsImV4cCI6MjA4MDE4NjE4N30.0d8KNO6QT7DQ3bAp190jlsSxNvwyUaPrse7CnYIrV_w';

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Supabase
        if (typeof supabase === 'undefined' || !supabase.createClient) {
            console.error('Supabase library not loaded!');
        }

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('Supabase client initialized:', supabaseClient);

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—É—Ä—Å—É –≤–∞–ª—é—Ç
        const getExchangeRate = async (currency, date) => {
            if (currency === 'USD') return 1;
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
                
                if (!response.ok) {
                    throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ');
                }
                
                const data = await response.json();
                
                const rates = {
                    'PLN': data.rates.PLN,
                    'EUR': data.rates.EUR
                };
                
                if (!rates[currency]) {
                    throw new Error('–í–∞–ª—é—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
                }
                
                return 1 / rates[currency];
            } catch (error) {
                console.warn('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é –∑–∞–ø–∞—Å–Ω—ñ –∫—É—Ä—Å–∏:', error.message);
                const fallbackRates = {
                    'PLN': 0.25,
                    'EUR': 1.08
                };
                return fallbackRates[currency] || 1;
            }
        };

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ—à—É–∫—É —Å—Ö–æ–∂–∏—Ö –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
        const findSimilarComments = (comment1, comment2) => {
            const normalize = (str) => str.toLowerCase().trim();
            const c1 = normalize(comment1);
            const c2 = normalize(comment2);
            
            if (c1 === c2) return true;
            
            const words1 = c1.split(/\s+/);
            const words2 = c2.split(/\s+/);
            
            const commonWords = words1.filter(w => words2.includes(w) && w.length > 3);
            
            return commonWords.length > 0 && commonWords.length >= Math.min(words1.length, words2.length) * 0.5;
        };

        function ExpenseTracker() {
            const [transactions, setTransactions] = useState([]);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [activeTab, setActiveTab] = useState('home');
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                amount: '',
                currency: 'PLN',
                comment: ''
            });
            const [editingId, setEditingId] = useState(null);
            const [loading, setLoading] = useState(false);
            const [syncStatus, setSyncStatus] = useState('connected');
            const [error, setError] = useState(null);

            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ Supabase
            useEffect(() => {
                loadTransactions();
            }, []);

            const loadTransactions = async () => {
                try {
                    setSyncStatus('syncing');
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .order('date', { ascending: true });

                    if (error) throw error;

                    setTransactions(data || []);
                    setSyncStatus('connected');
                    setError(null);
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', err);
                    setError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ Supabase');
                    setSyncStatus('error');
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                try {
                    const rate = await getExchangeRate(formData.currency, formData.date);
                    const usdAmount = parseFloat(formData.amount) * rate;

                    const transactionData = {
                        date: formData.date,
                        type: formData.type,
                        amount: parseFloat(formData.amount),
                        currency: formData.currency,
                        comment: formData.comment,
                        usd_amount: usdAmount,
                        rate: rate
                    };

                    if (editingId) {
                        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
                        const { error } = await supabase
                            .from('transactions')
                            .update(transactionData)
                            .eq('id', editingId);

                        if (error) throw error;
                        setEditingId(null);
                    } else {
                        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
                        const { error } = await supabase
                            .from('transactions')
                            .insert([transactionData]);

                        if (error) throw error;
                    }

                    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ
                    await loadTransactions();

                    setFormData({
                        date: new Date().toISOString().split('T')[0],
                        type: 'expense',
                        amount: '',
                        currency: 'PLN',
                        comment: ''
                    });
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', err);
                    setError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é');
                } finally {
                    setLoading(false);
                }
            };

            const handleEdit = (transaction) => {
                setFormData({
                    date: transaction.date,
                    type: transaction.type,
                    amount: transaction.amount,
                    currency: transaction.currency,
                    comment: transaction.comment || ''
                });
                setEditingId(transaction.id);
            };

            const handleDelete = async (id) => {
                if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é?')) return;

                try {
                    setSyncStatus('syncing');
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    await loadTransactions();
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è:', err);
                    setError('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é');
                    setSyncStatus('error');
                }
            };

            const changeMonth = (delta) => {
                const newDate = new Date(currentMonth);
                newDate.setMonth(newDate.getMonth() + delta);
                setCurrentMonth(newDate);
            };

            const filterTransactionsByMonth = (month = currentMonth) => {
                return transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month.getMonth() && 
                           tDate.getFullYear() === month.getFullYear();
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
            };

            const calculateSummary = (month = currentMonth) => {
                const monthTransactions = filterTransactionsByMonth(month);
                const income = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.usd_amount, 0);
                const expense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.usd_amount, 0);
                
                return { income, expense };
            };

            const generateForecast = () => {
                const now = new Date();
                const currentDate = new Date(currentMonth);
                
                if (currentDate <= now) return null;

                const last3Months = [];
                for (let i = 1; i <= 3; i++) {
                    const month = new Date(currentDate);
                    month.setMonth(month.getMonth() - i);
                    last3Months.push(month);
                }

                const expensesByComment = {};
                
                last3Months.forEach(month => {
                    const monthExpenses = filterTransactionsByMonth(month).filter(t => t.type === 'expense');
                    
                    monthExpenses.forEach(expense => {
                        const comment = (expense.comment || '').toLowerCase().trim();
                        if (!comment) return;
                        
                        let foundKey = null;
                        for (let key in expensesByComment) {
                            if (findSimilarComments(key, comment)) {
                                foundKey = key;
                                break;
                            }
                        }
                        
                        const keyToUse = foundKey || comment;
                        
                        if (!expensesByComment[keyToUse]) {
                            expensesByComment[keyToUse] = {
                                amounts: [],
                                originalComment: expense.comment
                            };
                        }
                        
                        expensesByComment[keyToUse].amounts.push(expense.usd_amount);
                    });
                });

                const regularExpenses = [];
                for (let comment in expensesByComment) {
                    const data = expensesByComment[comment];
                    if (data.amounts.length === 3) {
                        const avgAmount = data.amounts.reduce((a, b) => a + b, 0) / data.amounts.length;
                        regularExpenses.push({
                            comment: data.originalComment,
                            amount: avgAmount
                        });
                    }
                }

                return regularExpenses.length > 0 ? regularExpenses : null;
            };

            const createFromForecast = async (forecastItems) => {
                setLoading(true);
                try {
                    const currentDateStr = currentMonth.toISOString().split('T')[0].substring(0, 7) + '-01';
                    
                    const newTransactions = [];
                    for (let item of forecastItems) {
                        const rate = await getExchangeRate('USD', currentDateStr);
                        
                        newTransactions.push({
                            date: currentDateStr,
                            type: 'expense',
                            amount: item.amount,
                            currency: 'USD',
                            comment: item.comment,
                            usd_amount: item.amount,
                            rate: rate
                        });
                    }
                    
                    const { error } = await supabase
                        .from('transactions')
                        .insert(newTransactions);

                    if (error) throw error;

                    await loadTransactions();
                    alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —Å—Ç–≤–æ—Ä–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–æ–≥–Ω–æ–∑—É!');
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ –ø—Ä–æ–≥–Ω–æ–∑—É:', err);
                    setError('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó');
                } finally {
                    setLoading(false);
                }
            };

            const exportData = () => {
                // –ï–∫—Å–ø–æ—Ä—Ç —É CSV
                const headers = ['date', 'type', 'amount', 'currency', 'comment', 'usd_amount', 'rate'];
                const csvRows = [headers.join(',')];
                
                transactions.forEach(t => {
                    const row = [
                        t.date,
                        t.type,
                        t.amount,
                        t.currency,
                        `"${(t.comment || '').replace(/"/g, '""')}"`, // –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è –ª–∞–ø–æ–∫
                        t.usd_amount,
                        t.rate
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `expense-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            const importData = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ –¥–∞–Ω—ñ
                        await supabaseClient.from('transactions').delete().neq('id', 0);
                        
                        // –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –¥–∞–Ω—ñ
                        const importData = data.map(t => ({
                            date: t.date,
                            type: t.type,
                            amount: t.amount,
                            currency: t.currency,
                            comment: t.comment || t.comment,
                            usd_amount: t.usd_amount || t.usdAmount,
                            rate: t.rate
                        }));

                        const { error } = await supabaseClient
                            .from('transactions')
                            .insert(importData);

                        if (error) throw error;

                        await loadTransactions();
                        alert('–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É:', error);
                        alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –¥–∞–Ω–∏—Ö');
                    }
                };
                reader.readAsText(file);
            };

            const getAnalytics = () => {
                const currentSummary = calculateSummary(currentMonth);
                
                const prevMonth = new Date(currentMonth);
                prevMonth.setMonth(prevMonth.getMonth() - 1);
                const prevSummary = calculateSummary(prevMonth);

                const allMonths = {};
                transactions.forEach(t => {
                    const date = new Date(t.date);
                    const key = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!allMonths[key]) {
                        allMonths[key] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') allMonths[key].income += t.usd_amount;
                    if (t.type === 'expense') allMonths[key].expense += t.usd_amount;
                });

                const monthCount = Object.keys(allMonths).length || 1;
                const totalIncome = Object.values(allMonths).reduce((sum, m) => sum + m.income, 0);
                const totalExpense = Object.values(allMonths).reduce((sum, m) => sum + m.expense, 0);

                const avgIncome = totalIncome / monthCount;
                const avgExpense = totalExpense / monthCount;

                const chartData = [];
                for (let i = 5; i >= 0; i--) {
                    const month = new Date();
                    month.setMonth(month.getMonth() - i);
                    const summary = calculateSummary(month);
                    chartData.push({
                        month: month,
                        income: summary.income,
                        expense: summary.expense
                    });
                }

                return {
                    current: currentSummary,
                    previous: prevSummary,
                    avgIncome,
                    avgExpense,
                    chartData
                };
            };

            const monthTransactions = filterTransactionsByMonth();
            const summary = calculateSummary();
            const forecast = generateForecast();

            const monthNames = ['–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å',
                              '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'];

            return (
                <div className="container">
                    <h1>üí∞ –¢—Ä–µ–∫–µ—Ä –¥–æ—Ö–æ–¥—ñ–≤ —ñ –≤–∏—Ç—Ä–∞—Ç</h1>

                    <div className="sync-status">
                        <div className="sync-info">
                            <span className={`sync-badge ${syncStatus}`}>
                                {syncStatus === 'connected' && '‚úì –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Supabase'}
                                {syncStatus === 'syncing' && '‚ü≥ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...'}
                                {syncStatus === 'error' && '‚úï –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è'}
                            </span>
                        </div>
                        <button className="btn-secondary" onClick={loadTransactions} disabled={loading}>
                            ‚ü≥ –û–Ω–æ–≤–∏—Ç–∏
                        </button>
                    </div>

                    {error && (
                        <div className="error-message">
                            {error}
                        </div>
                    )}

                    <div className="nav-tabs">
                        <button 
                            className={`nav-tab ${activeTab === 'home' ? 'active' : ''}`}
                            onClick={() => setActiveTab('home')}
                        >
                            üè† –ì–æ–ª–æ–≤–Ω–∞
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'analytics' ? 'active' : ''}`}
                            onClick={() => setActiveTab('analytics')}
                        >
                            üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
                        </button>
                    </div>

                    {activeTab === 'home' && (
                        <>
                            <div className="card">
                                <form onSubmit={handleSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>–î–∞—Ç–∞</label>
                                            <input
                                                type="date"
                                                value={formData.date}
                                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label>–¢–∏–ø</label>
                                            <select
                                                value={formData.type}
                                                onChange={(e) => setFormData({...formData, type: e.target.value})}
                                            >
                                                <option value="income">–î–æ—Ö—ñ–¥</option>
                                                <option value="expense">–í–∏—Ç—Ä–∞—Ç–∞</option>
                                                <option value="exchange">–û–±–º—ñ–Ω</option>
                                            </select>
                                        </div>

                                        <div className="form-group">
                                            <label>–°—É–º–∞</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.amount}
                                                onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label>–í–∞–ª—é—Ç–∞</label>
                                            <select
                                                value={formData.currency}
                                                onChange={(e) => setFormData({...formData, currency: e.target.value})}
                                            >
                                                <option value="PLN">PLN</option>
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                            </select>
                                        </div>

                                        <div className="form-group" style={{gridColumn: 'span 2'}}>
                                            <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                                            <input
                                                type="text"
                                                value={formData.comment}
                                                onChange={(e) => setFormData({...formData, comment: e.target.value})}
                                                placeholder="–û–ø–∏—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó"
                                            />
                                        </div>
                                    </div>

                                    <button type="submit" disabled={loading}>
                                        {loading ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : editingId ? '–û–Ω–æ–≤–∏—Ç–∏' : '–î–æ–¥–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é'}
                                    </button>
                                    {editingId && (
                                        <button 
                                            type="button" 
                                            className="btn-secondary" 
                                            style={{marginLeft: '12px'}}
                                            onClick={() => {
                                                setEditingId(null);
                                                setFormData({
                                                    date: new Date().toISOString().split('T')[0],
                                                    type: 'expense',
                                                    amount: '',
                                                    currency: 'PLN',
                                                    comment: ''
                                                });
                                            }}
                                        >
                                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                                        </button>
                                    )}
                                </form>

                                <div style={{marginTop: '12px', textAlign: 'right'}}>
                                    <button 
                                        className="btn-secondary" 
                                        onClick={exportData}
                                        style={{fontSize: '12px', padding: '6px 10px', opacity: '0.6'}}
                                        title="–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö –≤ CSV"
                                    >
                                        ‚¨á CSV
                                    </button>
                                </div>
                            </div>

                            <div className="month-nav">
                                <button onClick={() => changeMonth(-1)}>‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π</button>
                                <div className="month-title">
                                    {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
                                </div>
                                <button onClick={() => changeMonth(1)}>–ù–∞—Å—Ç—É–ø–Ω–∏–π ‚Üí</button>
                            </div>

                            {forecast && (
                                <div className="forecast-section">
                                    <div className="forecast-title">
                                        üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –≤–∏—Ç—Ä–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 3 –º—ñ—Å—è—Ü—ñ–≤
                                    </div>
                                    {forecast.map((item, idx) => (
                                        <div key={idx} className="forecast-item">
                                            <span>{item.comment}</span>
                                            <strong>${item.amount.toFixed(2)}</strong>
                                        </div>
                                    ))}
                                    <div style={{
                                        marginTop: '12px',
                                        paddingTop: '12px',
                                        borderTop: '1px solid #ff9500',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        fontWeight: '600',
                                        fontSize: '16px'
                                    }}>
                                        <span>–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑:</span>
                                        <span>${forecast.reduce((sum, item) => sum + item.amount, 0).toFixed(2)}</span>
                                    </div>
                                    <div className="forecast-actions">
                                        <button 
                                            onClick={() => createFromForecast(forecast)}
                                            disabled={loading}
                                        >
                                            –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑ –ø—Ä–æ–≥–Ω–æ–∑—É
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="card">
                                {monthTransactions.length === 0 ? (
                                    <div className="loading">
                                        {forecast ? '–ù–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π. –°—Ç–≤–æ—Ä—ñ—Ç—å –∑ –ø—Ä–æ–≥–Ω–æ–∑—É –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É.' : '–ù–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π –∑–∞ —Ü–µ–π –º—ñ—Å—è—Ü—å'}
                                    </div>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>–î–∞—Ç–∞</th>
                                                <th>–¢–∏–ø</th>
                                                <th>–°—É–º–∞</th>
                                                <th>USD</th>
                                                <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                                                <th>–î—ñ—ó</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {monthTransactions.map(t => (
                                                <tr key={t.id} className={t.type}>
                                                    <td>{new Date(t.date).toLocaleDateString('uk-UA')}</td>
                                                    <td>
                                                        {t.type === 'income' ? '–î–æ—Ö—ñ–¥' : 
                                                         t.type === 'expense' ? '–í–∏—Ç—Ä–∞—Ç–∞' : '–û–±–º—ñ–Ω'}
                                                    </td>
                                                    <td className="tooltip">
                                                        {t.amount.toFixed(2)} {t.currency}
                                                        <span className="tooltiptext">
                                                            –ö—É—Ä—Å: 1 {t.currency} = ${t.rate.toFixed(4)}
                                                        </span>
                                                    </td>
                                                    <td>${t.usd_amount.toFixed(2)}</td>
                                                    <td>{t.comment}</td>
                                                    <td>
                                                        <div className="actions">
                                                            <button 
                                                                className="btn-small btn-secondary"
                                                                onClick={() => handleEdit(t)}
                                                            >
                                                                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                                                            </button>
                                                            <button 
                                                                className="btn-small btn-delete"
                                                                onClick={() => handleDelete(t.id)}
                                                            >
                                                                –í–∏–¥–∞–ª–∏—Ç–∏
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}

                                <div className="summary">
                                    <div className="summary-item">
                                        <div className="summary-label">üí∞ –î–æ—Ö–æ–¥–∏</div>
                                        <div className="summary-value income">
                                            ${summary.income.toFixed(2)}
                                        </div>
                                    </div>
                                    <div className="summary-item">
                                        <div className="summary-label">üí∏ –í–∏—Ç—Ä–∞—Ç–∏</div>
                                        <div className="summary-value expense">
                                            ${summary.expense.toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {activeTab === 'analytics' && (() => {
                        const analytics = getAnalytics();
                        const incomeChange = analytics.previous.income > 0 
                            ? ((analytics.current.income - analytics.previous.income) / analytics.previous.income * 100)
                            : 0;
                        const expenseChange = analytics.previous.expense > 0
                            ? ((analytics.current.expense - analytics.previous.expense) / analytics.previous.expense * 100)
                            : 0;

                        const maxValue = Math.max(...analytics.chartData.map(d => Math.max(d.income, d.expense)));

                        return (
                            <>
                                <div className="analytics-grid">
                                    <div className="stat-card">
                                        <div className="stat-title">–î–æ—Ö–æ–¥–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è</div>
                                        <div className="stat-value" style={{color: '#34c759'}}>
                                            ${analytics.current.income.toFixed(2)}
                                        </div>
                                        <div className={`stat-comparison ${incomeChange >= 0 ? 'positive' : 'negative'}`}>
                                            {incomeChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(incomeChange).toFixed(1)}% –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –º—ñ—Å—è—Ü—è
                                        </div>
                                    </div>

                                    <div className="stat-card">
                                        <div className="stat-title">–í–∏—Ç—Ä–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è</div>
                                        <div className="stat-value" style={{color: '#ff9500'}}>
                                            ${analytics.current.expense.toFixed(2)}
                                        </div>
                                        <div className={`stat-comparison ${expenseChange <= 0 ? 'positive' : 'negative'}`}>
                                            {expenseChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(expenseChange).toFixed(1)}% –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –º—ñ—Å—è—Ü—è
                                        </div>
                                    </div>

                                    <div className="stat-card">
                                        <div className="stat-title">–°–µ—Ä–µ–¥–Ω—ñ –¥–æ—Ö–æ–¥–∏</div>
                                        <div className="stat-value" style={{color: '#34c759'}}>
                                            ${analytics.avgIncome.toFixed(2)}
                                        </div>
                                        <div style={{fontSize: '14px', color: '#6e6e73'}}>
                                            –ó–∞ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é
                                        </div>
                                    </div>

                                    <div className="stat-card">
                                        <div className="stat-title">–°–µ—Ä–µ–¥–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏</div>
                                        <div className="stat-value" style={{color: '#ff9500'}}>
                                            ${analytics.avgExpense.toFixed(2)}
                                        </div>
                                        <div style={{fontSize: '14px', color: '#6e6e73'}}>
                                            –ó–∞ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é
                                        </div>
                                    </div>
                                </div>

                                <div className="chart-container">
                                    <div className="chart-title">–î–æ—Ö–æ–¥–∏ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∏ –ø–æ –º—ñ—Å—è—Ü—è—Ö</div>
                                    <div className="bar-chart">
                                        {analytics.chartData.map((data, idx) => (
                                            <div key={idx} className="bar-group">
                                                <div className="bars">
                                                    <div 
                                                        className="bar income-bar"
                                                        style={{height: `${(data.income / maxValue) * 100}%`}}
                                                    >
                                                        {data.income > 0 && (
                                                            <div className="bar-value" style={{color: '#34c759'}}>
                                                                ${data.income.toFixed(0)}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div 
                                                        className="bar expense-bar"
                                                        style={{height: `${(data.expense / maxValue) * 100}%`}}
                                                    >
                                                        {data.expense > 0 && (
                                                            <div className="bar-value" style={{color: '#ff9500'}}>
                                                                ${data.expense.toFixed(0)}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="bar-label">
                                                    {monthNames[data.month.getMonth()].substring(0, 3)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'center',
                                        gap: '20px',
                                        marginTop: '20px',
                                        fontSize: '14px'
                                    }}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <div style={{width: '16px', height: '16px', background: '#34c759', borderRadius: '4px'}}></div>
                                            <span>–î–æ—Ö–æ–¥–∏</span>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <div style={{width: '16px', height: '16px', background: '#ff9500', borderRadius: '4px'}}></div>
                                            <span>–í–∏—Ç—Ä–∞—Ç–∏</span>
                                        </div>
                                    </div>
                                </div>
                            </>
                        );
                    })()}
                </div>
            );
        }

        ReactDOM.render(<ExpenseTracker />, document.getElementById('root'));
    </script>
</body>
</html>
